# NavPlat Docker Compose Configuration
# For local development, you can create a .env file in the project root
# See .env.example for available configuration options

services:
  postgres:
    image: postgres:16-alpine
    container_name: navplat-postgres
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: JourneyDb
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: navplat-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ__USERNAME:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ__PASSWORD:-guest}
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: navplat-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_PORT: 8080
      KC_IMPORT: /opt/keycloak/data/import/navplat-realm.json
    command: start-dev --import-realm
    ports:
      - "8080:8080"
    volumes:
      - ./ops/keycloak/navplat-realm.json:/opt/keycloak/data/import/navplat-realm.json:ro
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /realms/navplat/.well-known/openid-configuration HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n' >&3 && head -1 <&3 | grep -q 'HTTP/1.1 200' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: navplat-jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "6831:6831/udp"
      - "16686:16686"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: navplat-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    volumes:
      - ./ops/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./ops/prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus-data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: navplat-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"

  gateway:
    build:
      context: .
      dockerfile: src/Gateway/Dockerfile
    container_name: navplat-gateway
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__GatewayDb: "Host=postgres;Port=5432;Database=GatewayDb;Username=${DB_USERNAME:-postgres};Password=${DB_PASSWORD:-postgres}"
      Authentication__Authority: ${AUTHENTICATION__AUTHORITY:-http://keycloak:8080/realms/navplat}
      Authentication__PublicAuthority: ${AUTHENTICATION__PUBLICAUTHORITY:-http://localhost:8080/realms/navplat}
      Authentication__ClientId: ${AUTHENTICATION__CLIENTID:-navplat-gateway}
      Authentication__ClientSecret: ${AUTHENTICATION__CLIENTSECRET:-gateway-secret}
      Authentication__Audience: ${AUTHENTICATION__AUDIENCE:-navplat-api}
      Authentication__RedirectUri: ${AUTHENTICATION__REDIRECTURI:-http://localhost:5000/signin-oidc}
      Authentication__Realm: ${AUTHENTICATION__REALM:-navplat}
      Keycloak__AdminClientId: ${KEYCLOAK__ADMINCLIENTID:-navplat-gateway}
      Keycloak__AdminClientSecret: ${KEYCLOAK__ADMINCLIENTSECRET:-gateway-secret}
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: ${RABBITMQ__USERNAME:-guest}
      RabbitMQ__Password: ${RABBITMQ__PASSWORD:-guest}
      Jaeger__Host: jaeger
      Jaeger__Port: 6831
      RateLimit__MaxLoginAttempts: ${RATELIMIT__MAXATTEMPTS:-5}
      RateLimit__WindowMinutes: ${RATELIMIT__WINDOWMINUTES:-1}
      Cors__AllowedOrigins__0: http://localhost:3000
    ports:
      - "${GATEWAY_PORT:-5000}:80"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  journey-api:
    build:
      context: .
      dockerfile: src/Services/Journey/Journey.API/Dockerfile
    container_name: navplat-journey-api
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__JourneyDb: "Host=postgres;Port=5432;Database=JourneyDb;Username=${DB_USERNAME:-postgres};Password=${DB_PASSWORD:-postgres}"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: ${RABBITMQ__USERNAME:-guest}
      RabbitMQ__Password: ${RABBITMQ__PASSWORD:-guest}
      Authentication__Authority: ${AUTH_AUTHORITY:-http://keycloak:8080/realms/navplat}
      Authentication__Audience: ${AUTH_AUDIENCE:-navplat-api}
      Jaeger__Host: jaeger
      Jaeger__Port: 6831
      Pagination__DefaultPageSize: ${PAGINATION__DEFAULTPAGESIZE:-20}
      Pagination__MaxPageSize: ${PAGINATION__MAXPAGESIZE:-100}
      Outbox__ProcessingIntervalSeconds: ${OUTBOX__PROCESSINGINTERVALSECONDS:-10}
      Outbox__BatchSize: ${OUTBOX__BATCHSIZE:-20}
      Frontend__Url: ${FRONTEND__URL:-http://localhost:3000}
    ports:
      - "${JOURNEY_API_PORT:-5001}:80"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  reward-worker:
    build:
      context: .
      dockerfile: src/Services/Reward/Reward.Worker/Dockerfile
    container_name: navplat-reward-worker
    environment:
      DOTNET_ENVIRONMENT: Development
      DOTNET_ROLL_FORWARD: Major
      ConnectionStrings__RewardDb: "Host=postgres;Port=5432;Database=RewardDb;Username=${DB_USERNAME:-postgres};Password=${DB_PASSWORD:-postgres}"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: ${RABBITMQ__USERNAME:-guest}
      RabbitMQ__Password: ${RABBITMQ__PASSWORD:-guest}
      Reward__DailyGoalKm: ${REWARD__DAILYGOALKM:-20.0}
      Reward__PointsPerKm: ${REWARD__POINTSPERKM:-10}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  notification-api:
    build:
      context: .
      dockerfile: src/Services/Notification/Notification.API/Dockerfile
    container_name: navplat-notification-api
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__NotificationDb: "Host=postgres;Port=5432;Database=NotificationDb;Username=${DB_USERNAME:-postgres};Password=${DB_PASSWORD:-postgres}"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: ${RABBITMQ__USERNAME:-guest}
      RabbitMQ__Password: ${RABBITMQ__PASSWORD:-guest}
      Authentication__Authority: ${AUTH_AUTHORITY:-http://keycloak:8080/realms/navplat}
      Authentication__Audience: ${AUTH_AUDIENCE:-navplat-api}
      Authentication__Realm: ${AUTHENTICATION__REALM:-navplat}
      Keycloak__AdminClientId: ${KEYCLOAK__ADMINCLIENTID:-navplat-gateway}
      Keycloak__AdminClientSecret: ${KEYCLOAK__ADMINCLIENTSECRET:-gateway-secret}
      Smtp__Host: ${SMTP__HOST:-mailhog}
      Smtp__Port: ${SMTP__PORT:-1025}
      Smtp__FromEmail: ${SMTP__FROMEMAIL:-notifications@navplat.local}
      Smtp__FromName: ${SMTP__FROMNAME:-NavPlat Notifications}
      Smtp__Username: ${SMTP__USERNAME:-}
      Smtp__Password: ${SMTP__PASSWORD:-}
      Smtp__EnableSsl: ${SMTP__ENABLESSL:-false}
      Jaeger__Host: jaeger
      Jaeger__Port: 6831
      Cors__AllowedOrigins__0: http://localhost:3000
      Cors__AllowedOrigins__1: http://gateway
    ports:
      - "${NOTIFICATION_API_PORT:-5002}:80"
    depends_on:
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      mailhog:
        condition: service_started
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: navplat-frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway
    restart: unless-stopped

volumes:
  postgres-data:
  prometheus-data:
